<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vendor Dashboard - Nibash (Gated)</title>

  <!-- Fonts + your stylesheet -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="../css/vendorDashboard.css" />

  <style>
    /* ---- Layout helpers ---- */
    .hidden { display: none !important; }
    .muted { color: #6b7280; }
    .row-actions { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .status { font-size: 0.9rem; }
    .products-grid { display:grid; grid-template-columns: repeat(auto-fill,minmax(160px,1fr)); gap:16px; }
    .product-card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 10px; overflow: hidden; }
    .product-card img { width: 100%; height: 120px; object-fit: cover; border-radius: 10px; }
    .card { border:1px solid #e5e7eb; border-radius:16px; padding:16px; background:#fff; }
    .form-grid { display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:12px; }
    .form-field { display:flex; flex-direction:column; gap:6px; }
    .form-field.col-span-2 { grid-column: span 2 / span 2; }
    .btn { padding:8px 14px; border-radius:10px; border:1px solid #11182710; cursor:pointer; background:#f3f4f6; }
    .btn.primary { background:#111827; color:#fff; }

    /* ---- Vendor type cards ---- */
    .type-grid { display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:12px; margin:12px 0; }
    .type-card { border:1px solid #e5e7eb; border-radius:14px; padding:12px; display:flex; gap:10px; align-items:flex-start; cursor:pointer; }
    .type-card input { margin-top:4px; }

    /* ---- Gated sections ---- */
    .gated { opacity: 0; pointer-events: none; transition: opacity .2s ease; }
    .gated.ready { opacity: 1; pointer-events: auto; }

    /* ---- Edit dialog ---- */
    .dialog-backdrop { position: fixed; inset: 0; background: #0006; display:none; align-items:center; justify-content:center; padding: 20px; }
    .dialog { width: 100%; max-width: 560px; background:#fff; border-radius:16px; border:1px solid #e5e7eb; box-shadow: 0 10px 30px #0003; padding: 16px; }
    .dialog header { display:flex; align-items:center; justify-content:space-between; margin-bottom: 12px; }
    .dialog footer { display:flex; gap:8px; justify-content:flex-end; margin-top: 12px; }
    .vendor-logo { width: 56px; height:56px; border-radius:12px; display:flex; align-items:center; justify-content:center; background:#111827; color:#fff; font-weight:600; font-size:20px; overflow:hidden; }
    .vendor-logo img { width:100%; height:100%; object-fit:cover; display:block; }
    .topbar { display:flex; align-items:center; justify-content:space-between; padding: 10px 16px; border-bottom: 1px solid #e5e7eb; background:#fff; position: sticky; top:0; z-index:5; }
    .dashboard-container { display:grid; grid-template-columns: 240px 1fr; min-height: calc(100vh - 56px); }
    .sidebar { border-right:1px solid #e5e7eb; padding: 16px; }
    .sidebar ul { list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:8px; }
    .sidebar li { padding:8px 10px; border-radius:8px; cursor:pointer; }
    .sidebar li.active, .sidebar li:hover { background:#f3f4f6; }
    .vendor-info { display:flex; gap:16px; align-items:center; justify-content:space-between; border:1px solid #e5e7eb; border-radius:16px; padding:16px; }
    .vendor-details { flex:1; display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:8px 16px; }
    .vendor-actions { display:flex; gap:8px; }

    /* ===========================
       Location Picker (scoped)
       Prefix: .lp-
       =========================== */
    .lp-modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:1000; }
    .lp-modal { width:min(900px, 96vw); background:#fff; color:#111827; border:1px solid #e5e7eb; border-radius:16px; overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,.35); }
    .lp-modal header { padding:10px 12px; border-bottom:1px solid #e5e7eb; display:flex; gap:8px; align-items:center; background:#fafafa; }
    .lp-modal header input { flex:1; border-radius:10px; border:1px solid #e5e7eb; background:#fff; color:#111827; padding:8px 10px; }
    #lp-map { height:60vh; width:100%; }
    .lp-bar { display:flex; gap:8px; align-items:center; }
    .lp-pad { padding:10px 12px; }
    .lp-actions { display:flex; gap:8px; justify-content:flex-end; border-top:1px solid #e5e7eb; padding:10px 12px; background:#fafafa; }
    .lp-btn { padding:8px 12px; border-radius:10px; border:1px solid #e5e7eb; background:#f3f4f6; cursor:pointer; }
    .lp-btn.primary { background:#111827; color:#fff; border-color:#111827; }
    .lp-muted { color:#6b7280; }
    .sidebar a { color: inherit; text-decoration: none; display:block; }
  </style>

  <!-- Leaflet (CSS/JS) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
    defer
  ></script>
</head>

<body>
  <!-- Top Navbar -->
  <header class="topbar">
    <div class="logo">
      <img src="../images/mainLogo.png" alt="Nibash Logo" />
      <span class="logo-text">Nibash</span>
    </div>
    <div class="nav-actions">
      <a href="../index.html">Home</a>
      <a href="./vendorDashboard.html">Vendor</a>
      <a href="./shop-nearby.html">Shop Nearby</a>
      <a href="./customerDashboard.html">Customer</a>
      <button class="logout-btn" id="logoutBtn">Log Out</button>
    </div>
  </header>

  <div class="dashboard-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <h3>My Account</h3>
      <ul>
        <li class="active"><a href="#profile">Profile</a></li>
        <li><a href="#createListingSection">Create</a></li>
        <li><a href="#myListingsSection">My Items</a></li>
        <li><a href="#statsSection">Analytics</a></li>
        <li><a href="#inquiriesSection">Messages</a></li>
        <li><a href="#typeGate">Settings</a></li>
      </ul>

      <h3 style="margin-top:16px">Quick Links</h3>
      <ul>
        <li><a href="../shop-nearby.html">Find Vendors Nearby</a></li>
        <li><a href="../customerDashboard.html">Customer Dashboard</a></li>
        <li><a href="../user.html">User Profile</a></li>
      </ul>
    </aside>

    <!-- Main Content -->
    <main class="content">
      <!-- Vendor Info (REAL data) -->
      <section class="vendor-info" id="profile">
        <div class="vendor-logo" id="companyLogoBox">V</div>
        <div class="vendor-details">
          <p><strong>Company Name:</strong> <span id="companyName">‚Äî</span></p>
          <p><strong>Contact:</strong> <span id="companyPhone">‚Äî</span></p>
          <p><strong>Email:</strong> <span id="companyEmail">‚Äî</span></p>
          <p><strong>Location:</strong> <span id="companyLocation">‚Äî</span></p>
          <p><strong>Job Type:</strong> <span id="companyJobType">‚Äî</span></p>
          <p class="col-span-2"><strong>Job Description:</strong> <span id="companyJobDesc">‚Äî</span></p>
        </div>

        <div class="vendor-actions">
          <button class="btn" id="editInfoBtn">Update Info</button>
        </div>
      </section>

      <!-- Business Location -->
      <section class="card" style="margin-top:16px;">
        <h3>Business Location</h3>
        <div class="form-grid">
          <label class="form-field">
            <span>Business Location (City/Area)</span>
            <input type="text" id="location" placeholder="e.g., Gulshan, Dhaka" />
          </label>
          <label class="form-field">
            <span>Latitude</span>
            <input type="number" id="latitude" step="0.000001" placeholder="23.810300" />
          </label>
          <label class="form-field">
            <span>Longitude</span>
            <input type="number" id="longitude" step="0.000001" placeholder="90.412500" />
          </label>
          <div class="form-field">
            <span>&nbsp;</span>
            <button class="btn primary" onclick="getLocationFromMap()">üìç Set Location on Map</button>
          </div>
        </div>
        <p class="muted" style="margin-top:8px">Tip: you can also paste lat/lon manually if you already know them.</p>
      </section>

      <!-- 1) Vendor Classification -->
      <section class="card" style="margin-top: 16px;" id="typeGate">
        <h3>Vendor Type</h3>
        <p class="muted">Classify your business to tailor your dashboard and listing form.</p>

        <div class="type-grid">
          <label class="type-card">
            <input type="radio" name="vendorType" value="seller" />
            <div>
              <strong>Seller</strong>
              <p>Furniture ‚Ä¢ Painting ‚Ä¢ Decoration ‚Ä¢ ‡¶¶‡ßá‡¶∂‡ßÄ‡ßü ‡¶Æ‡ßÉ‡¶§‡¶∂‡¶ø‡¶≤‡ßç‡¶™</p>
            </div>
          </label>

          <label class="type-card">
            <input type="radio" name="vendorType" value="service" />
            <div>
              <strong>Service Provider</strong>
              <p>Interior Designer ‚Ä¢ Electrician ‚Ä¢ Plumber ‚Ä¢ Painter</p>
            </div>
          </label>
        </div>

        <div class="row-actions">
          <button class="btn" id="saveTypeBtn" type="button">Save Type</button>
          <span id="typeStatus" class="status muted"></span>
        </div>
      </section>

      <!-- 2) Create Listing / Project (GATED) -->
      <section class="card gated hidden" id="createListingSection">
        <h3 id="createHeader">Create Listing</h3>
        <p class="muted" id="formHint">Choose your vendor type above to reveal the right fields.</p>

        <!-- Shared fields -->
        <div class="form-grid">
          <label class="form-field">
            <span>Title *</span>
            <input id="listingTitle" type="text" placeholder="e.g., Oak Study Desk / Plumbing Fix Package" />
          </label>

          <label class="form-field">
            <span>Description *</span>
            <textarea id="listingDesc" rows="3" placeholder="Describe your product/service..."></textarea>
          </label>
        </div>

        <!-- Seller-specific -->
        <div id="sellerFields" class="form-grid hidden">
          <label class="form-field">
            <span>Category *</span>
            <select id="productCategory">
              <option value="">Select a category</option>
            </select>
          </label>

          <label class="form-field">
            <span>Price (BDT) *</span>
            <input id="productPrice" type="number" min="0" step="1" placeholder="e.g., 4500" />
          </label>

          <label class="form-field">
            <span>Stock *</span>
            <input id="productStock" type="number" min="0" step="1" placeholder="e.g., 10" />
          </label>

          <label class="form-field col-span-2">
            <span>Image URL (optional)</span>
            <input id="productImage" type="url" placeholder="https://..." />
          </label>
        </div>

        <!-- Service-specific (Projects) -->
        <div id="serviceFields" class="form-grid hidden">
          <label class="form-field">
            <span>Project Type *</span>
            <select id="serviceCategory">
              <option value="">Select a project type</option>
            </select>
          </label>

          <label class="form-field">
            <span>Rate (BDT) *</span>
            <input id="serviceRate" type="number" min="0" step="1" placeholder="e.g., 1200" />
          </label>

          <label class="form-field">
            <span>Billing *</span>
            <select id="serviceBilling">
              <option value="fixed">Fixed</option>
              <option value="hourly">Hourly</option>
            </select>
          </label>

          <label class="form-field">
            <span>Service Area *</span>
            <input id="serviceArea" type="text" placeholder="e.g., Dhaka, BD" />
          </label>

          <label class="form-field col-span-2">
            <span>Project Photo (Image URL)</span>
            <input id="serviceImage" type="url" placeholder="https://..." />
          </label>
        </div>

        <div class="row-actions">
          <button class="btn" id="clearFormBtn" type="button">Clear</button>
          <button class="btn primary" id="createListingBtn" type="button">Save</button>
          <span id="createStatus" class="status muted"></span>
        </div>
      </section>

      <!-- 3) My Listings / Projects (GATED) -->
      <section class="card gated hidden" id="myListingsSection">
        <h3 id="myItemsHeader">My Listings</h3>
        <div class="row-actions" style="margin: 8px 0 12px;">
          <label class="form-field" style="min-width:240px;">
            <span id="filterLabel">Filter by category</span>
            <select id="categoryFilter"></select>
          </label>
        </div>
        <div id="listingsContainer" class="products-grid"></div>
        <p class="muted" id="noListings" style="display:none;">No items yet. Create one above.</p>
      </section>

      <!-- 4) Optional Dashboard Sections (GATED) -->
      <section class="card gated hidden" id="statsSection">
        <h3>Stats</h3>
        <div class="stats-cards">
          <div class="stat-box">
            <div class="stat-icon sold"><i class="fas fa-shopping-cart"></i></div>
            <p>Products Sold</p>
            <h2>124</h2>
          </div>
          <div class="stat-box">
            <div class="stat-icon stock"><i class="fas fa-boxes"></i></div>
            <p>In Stock</p>
            <h2>78</h2>
          </div>
          <div class="stat-box revenue"><i class="fas fa-dollar-sign"></i>
            <p>Total Revenue</p>
            <h2>$5,420</h2>
          </div>
          <div class="stat-box reviews">
            <div class="stat-icon reviews"><i class="fas fa-star"></i></div>
            <p>Reviews</p>
            <h2>320</h2>
          </div>
        </div>
      </section>

      <section class="card gated hidden" id="topProductsSection">
        <h3>Top-Performing Products</h3>
        <div class="products-grid">
          <div class="product-card">
            <img src="../images/p1.jpg" alt="Terracotta Vase" />
            <p>Terracotta Vase</p>
          </div>
          <div class="product-card processing">
            <img src="../images/p4.jpg" alt="Blue Bowl" />
            <p>Blue Bowl <span>Processing</span></p>
          </div>
          <div class="product-card">
            <img src="../images/p8.jpg" alt="Macrame Art" />
            <p>Macrame Art <span class="active">30 hours</span></p>
          </div>
        </div>
      </section>

      <section class="card gated hidden" id="inquiriesSection">
        <h3>Customer Inquiries</h3>
        <p><strong>Maisha:</strong> Interested in vase (1 min ago)</p>
        <p><strong>New Followers:</strong> 45</p>
      </section>
    </main>
  </div>

  <!-- Update Info Dialog -->
  <div class="dialog-backdrop" id="editDialog">
    <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="editDialogTitle">
      <header>
        <h3 id="editDialogTitle">Update Vendor Info</h3>
        <button class="btn" id="closeEditBtn" aria-label="Close">‚úï</button>
      </header>
      <div class="form-grid">
        <label class="form-field">
          <span>Company Name *</span>
          <input id="editCompanyName" type="text" />
        </label>
        <label class="form-field">
          <span>Phone *</span>
          <input id="editCompanyPhone" type="text" />
        </label>
        <label class="form-field">
          <span>Location *</span>
          <input id="editCompanyLocation" type="text" placeholder="e.g., Dhaka, BD" />
        </label>
        <label class="form-field">
          <span>Email *</span>
          <input id="editCompanyEmail" type="email" />
        </label>
        <label class="form-field">
          <span>Job Type *</span>
          <select id="editJobType">
            <option value="">Select job type</option>
            <option>Interior Designer</option>
            <option>Electrician</option>
            <option>Plumber</option>
            <option>Painter</option>
            <option>Carpenter</option>
            <option>Other</option>
          </select>
        </label>
        <label class="form-field col-span-2">
          <span>Vendor Description</span>
          <textarea id="editJobDescription" rows="3" placeholder="Short description about your services/skills"></textarea>
        </label>
        <label class="form-field col-span-2">
          <span>Logo URL (optional)</span>
          <input id="editLogoUrl" type="url" placeholder="https://..." />
        </label>
      </div>
      <footer>
        <span id="editStatus" class="status muted" style="margin-right:auto"></span>
        <button class="btn" id="resetEditBtn" type="button">Reset</button>
        <button class="btn primary" id="saveEditBtn" type="button">Save Changes</button>
      </footer>
    </div>
  </div>

  <!-- Location Picker MODAL -->
  <div id="lp-modal" class="lp-modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="lp-modal">
      <header>
        <strong style="font-size:14px;">Pick a spot</strong>
        <input id="lp-search" type="text" placeholder="Search a place (e.g., Banani, Dhaka)" />
        <button class="lp-btn" id="lp-search-btn" title="Search">Search</button>
        <button class="lp-btn" id="lp-myLoc-btn" title="Use my location">My Location</button>
        <button class="lp-btn" id="lp-close-btn" title="Close">‚úï</button>
      </header>
      <div id="lp-map"></div>
      <div class="lp-pad lp-bar" id="lp-preview">
        <div class="lp-muted">Click on the map to choose a point.</div>
      </div>
      <div class="lp-actions">
        <button class="lp-btn" id="lp-cancel-btn">Cancel</button>
        <button class="lp-btn primary" id="lp-confirm-btn">Confirm Selection</button>
      </div>
    </div>
  </div>

  <script>
/* =========================================================
 * CONFIG: dynamic API base (same-origin if served, else localhost:5555)
 * =======================================================*/
const API_BASE = (() => {
  try {
    if (location.origin && /^https?:\/\//.test(location.origin)) return location.origin;
  } catch {}
  return 'http://localhost:5555';
})();

/* =========================================================
 * STATE (session)
 * =======================================================*/
let VENDOR_ID = Number(localStorage.getItem("vendorId")) || null;
const TOKEN = localStorage.getItem("vendorToken") || null;

// Guard: if not authenticated, go to login
if (!VENDOR_ID || !TOKEN) {
  window.location.href = "vendorLogin.html";
}

/* =========================================================
 * SIDEBAR / LOGOUT
 * =======================================================*/
const logoutBtn = document.getElementById("logoutBtn");
if (logoutBtn) {
  logoutBtn.addEventListener("click", () => {
    localStorage.removeItem("vendorId");
    localStorage.removeItem("vendorToken");
    localStorage.removeItem("vendorType");
    window.location.href = "../index.html";
  });
}

// Sidebar active highlight on click
document.querySelectorAll('.sidebar ul li').forEach((item) => {
  item.addEventListener('click', () => {
    document.querySelectorAll('.sidebar ul li').forEach((i) => i.classList.remove('active'));
    item.classList.add('active');
  });
});

/* =========================================================
 * DOM HANDLES
 * =======================================================*/
const typeRadios = document.querySelectorAll('input[name="vendorType"]');
const saveTypeBtn = document.getElementById('saveTypeBtn');
const typeStatus = document.getElementById('typeStatus');
const sellerFields = document.getElementById('sellerFields');
const serviceFields = document.getElementById('serviceFields');
const formHint = document.getElementById('formHint');
const createHeader = document.getElementById('createHeader');

const productCategorySel = document.getElementById('productCategory');
const serviceCategorySel = document.getElementById('serviceCategory');

const categoryFilter = document.getElementById('categoryFilter');
const listingsContainer = document.getElementById('listingsContainer');
const noListings = document.getElementById('noListings');
const createBtn = document.getElementById('createListingBtn');
const clearBtn = document.getElementById('clearFormBtn');
const createStatus = document.getElementById('createStatus');
const myItemsHeader = document.getElementById('myItemsHeader');
const filterLabel = document.getElementById('filterLabel');

// Profile display nodes
const companyLogoBox = document.getElementById('companyLogoBox');
const companyNameEl = document.getElementById('companyName');
const companyPhoneEl = document.getElementById('companyPhone');
const companyLocationEl = document.getElementById('companyLocation');
const companyEmailEl = document.getElementById('companyEmail');
const companyJobTypeEl = document.getElementById('companyJobType');
const companyJobDescEl = document.getElementById('companyJobDesc');

// Edit dialog nodes
const editDialog = document.getElementById('editDialog');
const editCompanyName = document.getElementById('editCompanyName');
const editCompanyPhone = document.getElementById('editCompanyPhone');
const editCompanyLocation = document.getElementById('editCompanyLocation');
const editCompanyEmail = document.getElementById('editCompanyEmail');
const editLogoUrl = document.getElementById('editLogoUrl');
const editJobType = document.getElementById('editJobType');
const editJobDescription = document.getElementById('editJobDescription');
const editStatus = document.getElementById('editStatus');
const editInfoBtn = document.getElementById('editInfoBtn');
const closeEditBtn = document.getElementById('closeEditBtn');
const resetEditBtn = document.getElementById('resetEditBtn');
const saveEditBtn = document.getElementById('saveEditBtn');

/* =========================================================
 * UI HELPERS
 * =======================================================*/
const GATED_SECTION_IDS = [
  'createListingSection',
  'myListingsSection',
  'statsSection',
  'topProductsSection',
  'inquiriesSection',
];

function setGateVisibility(type) {
  const show = type === 'seller' || type === 'service';
  GATED_SECTION_IDS.forEach((id) => {
    const el = document.getElementById(id);
    if (!el) return;
    if (show) {
      el.classList.remove('hidden');
      requestAnimationFrame(() => el.classList.add('ready'));
    } else {
      el.classList.add('hidden');
      el.classList.remove('ready');
    }
  });
}

function updateFormForType(type) {
  if (type === 'seller') {
    createHeader.textContent = 'Create Listing';
    myItemsHeader.textContent = 'My Listings';
    filterLabel.textContent = 'Filter by category';
    sellerFields.classList.remove('hidden');
    serviceFields.classList.add('hidden');
    formHint.textContent = 'Create a product listing to sell on Nibash.';
  } else if (type === 'service') {
    createHeader.textContent = 'Create Project';
    myItemsHeader.textContent = 'My Projects';
    filterLabel.textContent = 'Filter by project type';
    sellerFields.classList.add('hidden');
    serviceFields.classList.remove('hidden');
    formHint.textContent = 'Create a project/service package listing for customers.';
  } else {
    sellerFields.classList.add('hidden');
    serviceFields.classList.add('hidden');
    createHeader.textContent = 'Create Listing';
    myItemsHeader.textContent = 'My Listings';
    filterLabel.textContent = 'Filter by category';
    formHint.textContent = 'Choose your vendor type above to reveal the right fields.';
  }
}

function showErrorInline(el, msg) { if (el) { el.textContent = msg; el.style.color = 'crimson'; } }
function showSuccessInline(el, msg) { if (el) { el.textContent = msg; el.style.color = 'green'; } }

function setLogo(logoUrl, fallbackName) {
  if (logoUrl) {
    companyLogoBox.innerHTML = `<img alt="${fallbackName || 'Vendor'} Logo" src="${logoUrl}" onerror="this.closest('.vendor-logo').textContent='${(fallbackName||'V').slice(0,1)}'" />`;
  } else {
    companyLogoBox.textContent = (fallbackName || 'V').slice(0,1);
  }
}
function pretty(v) { return v ? String(v).replace(/_/g, ' ') : v; }

/* =========================================================
 * API LAYER
 * =======================================================*/
function authHeaders() { return TOKEN ? { Authorization: `Bearer ${TOKEN}` } : {}; }

async function apiGET(path) {
  const res = await fetch(`${API_BASE}${path}`, { headers: { ...authHeaders() } });
  const json = await res.json().catch(() => ({}));
  if (!res.ok || json.ok === false) throw new Error(json.error || `GET ${path} failed`);
  return json.data ?? json;
}
async function apiJSON(path, method, body) {
  const res = await fetch(`${API_BASE}${path}`, {
    method,
    headers: { "Content-Type": "application/json", ...authHeaders() },
    body: JSON.stringify(body || {}),
  });
  const json = await res.json().catch(() => ({}));
  if (!res.ok || json.ok === false) throw new Error(json.error || `${method} ${path} failed`);
  return json.data ?? json;
}

/* =========================================================
 * LOOKUPS (categories)
 * =======================================================*/
async function loadLookups() {
  const prodCats = await apiGET("/api/lookups/product-categories");
  productCategorySel.innerHTML =
    `<option value="">Select a category</option>` +
    prodCats.map(c => `<option value="${c.slug}">${c.name}</option>`).join("");

  const servCats = await apiGET("/api/lookups/service-categories");
  serviceCategorySel.innerHTML =
    `<option value="">Select a project type</option>` +
    servCats.map(c => `<option value="${c.slug}">${c.name}</option>`).join("");
}

async function buildCategoryFilter() {
  const type = localStorage.getItem('vendorType') || '';
  if (!type) { categoryFilter.innerHTML = ''; return; }
  if (type === 'seller') {
    const cats = await apiGET("/api/lookups/product-categories");
    categoryFilter.innerHTML =
      `<option value="">All product categories</option>` +
      cats.map(c => `<option value="${c.slug}">${c.name}</option>`).join("");
  } else {
    const cats = await apiGET("/api/lookups/service-categories");
    categoryFilter.innerHTML =
      `<option value="">All project types</option>` +
      cats.map(c => `<option value="${c.slug}">${c.name}</option>`).join("");
  }
}

/* =========================================================
 * VENDOR PROFILE (REAL DATA)
 * =======================================================*/
let VENDOR_PROFILE = null;

async function loadVendorProfile() {
  try {
    const me = await apiGET('/api/vendors/me');
    VENDOR_PROFILE = me;

    companyNameEl.textContent = me.company_name || '‚Äî';
    companyPhoneEl.textContent = me.phone || '‚Äî';
    companyEmailEl.textContent = me.email || '‚Äî';
    companyLocationEl.textContent = me.location || '‚Äî';
    companyJobTypeEl.textContent = pretty(me.job_type) || '‚Äî';
    companyJobDescEl.textContent = me.Vendor_description || '‚Äî';
    setLogo(me.logo_url, me.company_name);

    if (me.email) localStorage.setItem('vendorEmail', me.email);
    if (me.vendor_id) localStorage.setItem('vendorId', String(me.vendor_id));
  } catch (e) {
    console.error('Failed to load vendor profile', e);
    showErrorInline(editStatus, e.message);
  }
}

function openEditDialog(prefillFrom) {
  editStatus.textContent = '';
  editDialog.style.display = 'flex';
  document.body.style.overflow = 'hidden';

  const src = prefillFrom || VENDOR_PROFILE || {};
  editCompanyName.value = src.company_name || '';
  editCompanyPhone.value = src.phone || '';
  editCompanyLocation.value = src.location || '';
  editCompanyEmail.value = src.email || '';
  editLogoUrl.value = src.logo_url || '';
  editJobType.value = src.job_type || '';
  editJobDescription.value = src.Vendor_description || '';
}

function closeEditDialog() {
  editDialog.style.display = 'none';
  document.body.style.overflow = '';
}

async function saveVendorProfileUpdate() {
  try {
    showErrorInline(editStatus, '');
    editStatus.textContent = 'Saving...';
    editStatus.style.color = 'inherit';

    const payload = {
      company_name: editCompanyName.value.trim(),
      phone: editCompanyPhone.value.trim(),
      location: editCompanyLocation.value.trim(),
      email: editCompanyEmail.value.trim(),
      logo_url: editLogoUrl.value.trim() || null,
      job_type: editJobType.value.trim(),
      Vendor_description: editJobDescription.value.trim(),
    };

    if (!payload.company_name || !payload.phone || !payload.location || !payload.email || !payload.job_type) {
      throw new Error('Please fill in Company Name, Phone, Location, Email, and Job Type.');
    }

    const updated = await apiJSON('/api/vendors/me', 'PATCH', payload);
    VENDOR_PROFILE = updated;

    companyNameEl.textContent = updated.company_name || '‚Äî';
    companyPhoneEl.textContent = updated.phone || '‚Äî';
    companyEmailEl.textContent = updated.email || '‚Äî';
    companyLocationEl.textContent = updated.location || '‚Äî';
    companyJobTypeEl.textContent = pretty(updated.job_type) || '‚Äî';
    companyJobDescEl.textContent = updated.Vendor_description || '‚Äî';
    setLogo(updated.logo_url, updated.company_name);

    showSuccessInline(editStatus, 'Saved!');
    setTimeout(closeEditDialog, 600);
  } catch (e) {
    showErrorInline(editStatus, e.message);
  }
}

/* =========================================================
 * VENDOR TYPE (DB-backed)
 * =======================================================*/
async function loadVendorTypeFromDB() {
  try {
    const data = await apiGET(`/api/vendors/me/type`);
    return data?.vendor_type || "";
  } catch {
    return "";
  }
}

const saveTypeBtnEl = document.getElementById('saveTypeBtn');
if (saveTypeBtnEl) {
  saveTypeBtnEl.addEventListener('click', async () => {
    const selected = document.querySelector('input[name="vendorType"]:checked');
    if (!selected) { showErrorInline(typeStatus, "Select a type first."); setGateVisibility(''); return; }
    try {
      await apiJSON(`/api/vendors/me/type`, "PATCH", { vendor_type: selected.value });
      localStorage.setItem('vendorType', selected.value);
      showSuccessInline(typeStatus, "Saved!");
      setGateVisibility(selected.value);
      await buildCategoryFilter();
      await renderListingsFromAPI();
      document.getElementById('listingTitle')?.focus();
    } catch (e) {
      showErrorInline(typeStatus, e.message);
    }
  });
}

(typeRadios || []).forEach((r) => {
  r.addEventListener('change', async () => {
    updateFormForType(r.value);
    setGateVisibility(r.value);
    localStorage.setItem('vendorType', r.value);
    await buildCategoryFilter();
    await renderListingsFromAPI();
  });
});

/* =========================================================
 * LISTINGS (Create + Render)
 * =======================================================*/
function readListingForm() {
  const type = localStorage.getItem('vendorType');
  const title = document.getElementById('listingTitle').value.trim();
  const description = document.getElementById('listingDesc').value.trim();

  if (!type) throw new Error('Please choose your vendor type above.');
  if (!title || !description) throw new Error('Title and Description are required.');

  if (type === 'seller') {
    const category = productCategorySel.value;
    const price = document.getElementById('productPrice').value;
    const stock = document.getElementById('productStock').value;
    const image_url = document.getElementById('productImage').value.trim();
    if (!category || price === '' || stock === '') throw new Error('Please complete all product fields.');
    return { type, title, description, category, price: parseInt(price,10), stock: parseInt(stock,10), image_url: image_url || null };
  } else {
    const service_type = serviceCategorySel.value;
    const rate = document.getElementById('serviceRate').value;
    const billing = document.getElementById('serviceBilling').value;
    const area = document.getElementById('serviceArea').value.trim();
    const image_url = document.getElementById('serviceImage').value.trim();
    if (!service_type || rate === '' || !billing || !area) throw new Error('Please complete all project fields.');
    return { type, title, description, service_type, rate: parseInt(rate,10), billing, area, image_url: image_url || null };
  }
}

async function saveListingToAPI(listing) {
  if (listing.type === "seller") {
    await apiJSON("/api/products", "POST", {
      title: listing.title,
      description: listing.description,
      category_slug: listing.category,
      price_bdt: listing.price,
      stock: listing.stock,
      image_url: listing.image_url || null,
    });
  } else {
    await apiJSON("/api/services", "POST", {
      title: listing.title,
      description: listing.description,
      service_category_slug: listing.service_type,
      rate_bdt: listing.rate,
      billing: listing.billing,
      service_area: listing.area,
      image_url: listing.image_url || null,
    });
  }
}

async function renderListingsFromAPI() {
  const type = localStorage.getItem('vendorType');
  listingsContainer.innerHTML = '';

  if (!type) {
    noListings.style.display = 'block';
    noListings.textContent = 'Choose a vendor type to view or create items.';
    return;
  }

  const selectedFilter = (categoryFilter && categoryFilter.value) || '';
  let url = type === 'seller' ? `/api/products` : `/api/services`;
  url += `?vendor_id=${encodeURIComponent(VENDOR_ID)}`;
  if (selectedFilter) url += `&category_slug=${encodeURIComponent(selectedFilter)}`;

  try {
    const rows = await apiGET(url);
    if (!rows.length) {
      noListings.style.display = 'block';
      noListings.textContent = type === 'seller' ? 'No listings yet. Create one above.' : 'No projects yet. Create one above.';
      return;
    }
    noListings.style.display = 'none';

    rows.forEach((item) => {
      const card = document.createElement('div');
      card.className = 'product-card';

      let imgUrl = (localStorage.getItem('vendorType') === 'service')
        ? (item.image_url || null)
        : (item.image_url || item.primary_image_url || null);
      if (!imgUrl) imgUrl = '../images/placeholder.jpg';

      if (imgUrl) {
        const img = document.createElement('img');
        img.src = imgUrl;
        img.alt = item.title;
        card.appendChild(img);
      }

      const p = document.createElement('p');
      const subRaw = item.category_slug || item.category_name || (type === 'seller' ? 'Product' : 'Project');
      p.innerHTML = `<strong>${item.title}</strong><br><span class="muted">${pretty(subRaw)}</span>`;
      card.appendChild(p);

      listingsContainer.appendChild(card);
    });
  } catch (err) {
    noListings.style.display = 'block';
    noListings.textContent = `Failed to load items: ${err.message}`;
  }
}

function clearForm() {
  document.getElementById('listingTitle').value = '';
  document.getElementById('listingDesc').value = '';
  const ids = ['productCategory','productPrice','productStock','productImage','serviceCategory','serviceRate','serviceBilling','serviceArea','serviceImage'];
  ids.forEach((id) => {
    const el = document.getElementById(id);
    if (!el) return;
    if (el.tagName === 'SELECT') {
      if (id === 'serviceBilling') el.value = 'fixed'; else el.value = '';
    } else el.value = '';
  });
}

/* =========================================================
 * LOCATION PICKER (scoped)
 * =======================================================*/
let lpMap, lpMarker, lpSelected = null;

async function getLocationFromMap() {
  lpOpen();
  await lpEnsureMap();
  lpMap.invalidateSize();
}
function lpOpen() {
  const m = document.getElementById('lp-modal');
  m.style.display = 'flex';
  m.setAttribute('aria-hidden', 'false');
}
function lpClose() {
  const m = document.getElementById('lp-modal');
  m.style.display = 'none';
  m.setAttribute('aria-hidden', 'true');
}
async function lpEnsureMap() {
  if (lpMap) return;
  lpMap = L.map('lp-map').setView([23.780887, 90.279239], 12);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(lpMap);

  lpMap.on("click", async (e) => {
    lpSetPoint(e.latlng.lat, e.latlng.lng);
    const label = await lpReverseGeocode(e.latlng.lat, e.latlng.lng);
    lpSetPreview(e.latlng.lat, e.latlng.lng, label);
  });

  document.getElementById('lp-search-btn').addEventListener('click', () => lpDoSearch(document.getElementById('lp-search').value));
  document.getElementById('lp-search').addEventListener('keydown', (ev) => { if (ev.key === 'Enter') lpDoSearch(ev.target.value); });
  document.getElementById('lp-myLoc-btn').addEventListener('click', () => {
    if (!navigator.geolocation) return alert("Geolocation not available");
    navigator.geolocation.getCurrentPosition(async (pos) => {
      const lat = pos.coords.latitude, lon = pos.coords.longitude;
      lpMap.setView([lat, lon], 15);
      lpSetPoint(lat, lon);
      const label = await lpReverseGeocode(lat, lon);
      lpSetPreview(lat, lon, label);
    }, (err) => alert(err.message), { enableHighAccuracy: true, timeout: 10000 });
  });
  document.getElementById('lp-close-btn').addEventListener('click', lpClose);
  document.getElementById('lp-cancel-btn').addEventListener('click', lpClose);
  document.getElementById('lp-confirm-btn').addEventListener('click', () => {
    if (!lpSelected) { alert("Please pick a spot on the map."); return; }
    const { lat, lon, label } = lpSelected;
    document.getElementById('location').value = label || `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
    document.getElementById('latitude').value = lat.toFixed(6);
    document.getElementById('longitude').value = lon.toFixed(6);
    lpClose();
  });
}
function lpSetPoint(lat, lon) {
  if (lpMarker) lpMap.removeLayer(lpMarker);
  lpMarker = L.marker([lat, lon]).addTo(lpMap);
  lpSelected = { lat, lon, label: lpSelected?.label };
}
function lpSetPreview(lat, lon, label) {
  lpSelected = { lat, lon, label: label || lpSelected?.label };
  document.getElementById('lp-preview').innerHTML =
    `<div><div><strong>Selected:</strong> ${lpEscape(label || "Unnamed place")}</div><div class="lp-muted">${lat.toFixed(6)}, ${lon.toFixed(6)}</div></div>`;
}
async function lpDoSearch(q) {
  q = (q || "").trim();
  if (!q) return;
  try {
    const url = `https://nominatim.openstreetmap.org/search?format=jsonv2&limit=1&q=${encodeURIComponent(q)}`;
    const res = await fetch(url, { headers: { "Accept": "application/json" } });
    const arr = await res.json();
    if (!arr.length) { alert("No results found."); return; }
    const item = arr[0];
    const lat = parseFloat(item.lat), lon = parseFloat(item.lon);
    lpMap.setView([lat, lon], 15);
    lpSetPoint(lat, lon);
    lpSetPreview(lat, lon, item.display_name);
  } catch (e) {
    console.error(e);
    alert("Search failed. Try a different query.");
  }
}
async function lpReverseGeocode(lat, lon) {
  try {
    const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`;
    const res = await fetch(url, { headers: { "Accept": "application/json" } });
    const data = await res.json();
    return data.display_name || "";
  } catch { return ""; }
}
const lpEscape = (s) => String(s ?? "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");

/* =========================================================
 * INIT + EVENT BINDINGS
 * =======================================================*/
if (editInfoBtn) editInfoBtn.addEventListener('click', () => openEditDialog());
if (closeEditBtn) closeEditBtn.addEventListener('click', closeEditDialog);
if (resetEditBtn) resetEditBtn.addEventListener('click', () => openEditDialog(VENDOR_PROFILE));
if (saveEditBtn) saveEditBtn.addEventListener('click', saveVendorProfileUpdate);

if (createBtn) {
  createBtn.addEventListener('click', async () => {
    try {
      showErrorInline(createStatus, "");
      createStatus.textContent = 'Saving...';
      createStatus.style.color = 'inherit';

      const listing = readListingForm();
      await saveListingToAPI(listing);
      await buildCategoryFilter();
      await renderListingsFromAPI();
      clearForm();

      showSuccessInline(createStatus, 'Saved!');
      listingsContainer.scrollIntoView({ behavior: 'smooth' });
    } catch (e) {
      showErrorInline(createStatus, e.message);
    }
  });
}
if (clearBtn) {
  clearBtn.addEventListener('click', () => { clearForm(); createStatus.textContent = ''; });
}

(async function init() {
  try {
    await loadVendorProfile();
    await loadLookups();
    let vt = await loadVendorTypeFromDB();
    if (!vt) vt = localStorage.getItem('vendorType') || '';
    if (vt) {
      const radio = document.querySelector(`input[name="vendorType"][value="${vt}"]`);
      if (radio) radio.checked = true;
      localStorage.setItem('vendorType', vt);
    }
    updateFormForType(vt);
    setGateVisibility(vt);
    await buildCategoryFilter();
    await renderListingsFromAPI();
  } catch (e) {
    console.error(e);
  }
})();

/* Reviews section (optional, shown if API exists) */
async function loadMyReviews() {
  try {
    const vendorId = Number(localStorage.getItem('vendorId'));
    if (!vendorId) return;
    const res = await fetch(`${API_BASE}/api/reviews/vendor/${vendorId}`);
    const json = await res.json();
    if (!res.ok || json.ok === false) throw new Error(json.error || 'reviews failed');

    const wrap = document.createElement('section');
    wrap.className = 'card gated hidden';
    wrap.id = 'reviewsSection';
    const stats = json.data.stats || { avg_rating: null, total: 0 };
    wrap.innerHTML = `
      <h3>Your Reviews</h3>
      <p class="muted">Average: ${(stats.avg_rating ?? 0).toFixed(2)} (${stats.total} reviews)</p>
      <div id="reviewsList"></div>
    `;
    document.querySelector('.content').appendChild(wrap);

    const list = wrap.querySelector('#reviewsList');
    (json.data.reviews || []).forEach(r => {
      const div = document.createElement('div');
      div.style.borderTop = '1px solid #e5e7eb';
      div.style.padding = '8px 0';
      div.innerHTML = `<strong>${'‚òÖ'.repeat(r.rating)}${'‚òÜ'.repeat(5-r.rating)}</strong> ‚Äî ${r.customer_name || 'Customer'}<br>
                       <span class="muted">${new Date(r.created_at).toLocaleString()}</span><br>
                       ${r.comment ? `<div>${r.comment}</div>` : ''}`;
      list.appendChild(div);
    });

    wrap.classList.remove('hidden');
    requestAnimationFrame(() => wrap.classList.add('ready'));
  } catch (e) {
    console.warn('reviews failed', e.message);
  }
}
(async function initAppendReviews() { try { await loadMyReviews(); } catch {} })();
  </script>
</body>
</html>
