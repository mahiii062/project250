<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vendor Dashboard - Nibash (Gated)</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="../css/vendorDashboard.css" />
  <style>
    /* Minimal helpers so we don't rely on external CSS for visibility */
    .hidden { display: none !important; }
    .muted { color: #6b7280; }
    .row-actions { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .status { font-size: 0.9rem; }
    .products-grid { display:grid; grid-template-columns: repeat(auto-fill,minmax(160px,1fr)); gap:16px; }
    .product-card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 10px; overflow: hidden; }
    .product-card img { width: 100%; height: 120px; object-fit: cover; border-radius: 10px; }
    .card { border:1px solid #e5e7eb; border-radius:16px; padding:16px; background:#fff; }
    .form-grid { display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:12px; }
    .form-field { display:flex; flex-direction:column; gap:6px; }
    .form-field.col-span-2 { grid-column: span 2 / span 2; }
    .btn { padding:8px 14px; border-radius:10px; border:1px solid #11182710; cursor:pointer; background:#f3f4f6; }
    .btn.primary { background:#111827; color:#fff; }
    .type-grid { display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:12px; margin:12px 0; }
    .type-card { border:1px solid #e5e7eb; border-radius:14px; padding:12px; display:flex; gap:10px; align-items:flex-start; cursor:pointer; }
    .type-card input { margin-top:4px; }
    /* Gated sections share this class for easy toggling */
    .gated { opacity: 0; pointer-events: none; transition: opacity .2s ease; }
    .gated.ready { opacity: 1; pointer-events: auto; }
  </style>
</head>
<body>
  <!-- Top Navbar -->
  <header class="topbar">
    <div class="logo">
      <img src="../images/mainLogo.png" alt="Nibash Logo" />
      <span class="logo-text">Nibash</span>
    </div>
    <div class="nav-actions">
      <a href="#">Home</a>
      <a href="#">Vendor</a>
      <button class="logout-btn" onclick="location.href='../index.html'">Log Out</button>
    </div>
  </header>

  <div class="dashboard-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <h3>My Account</h3>
      <ul>
        <li class="active">Profile</li>
        <li>Products</li>
        <li>Orders</li>
        <li>Analytics</li>
        <li>Messages</li>
        <li>Settings</li>
      </ul>
    </aside>

    <!-- Main Content -->
    <main class="content">
      <!-- Vendor Info (unchanged) -->
      <section class="vendor-info">
        <div class="vendor-logo">V</div>
        <div class="vendor-details">
          <p><strong>Company Name:</strong> Clay & Craft</p>
          <p><strong>Contact:</strong> 555-987-8643</p>
          <p><strong>Location:</strong> Dhaka, BD</p>
          <p><strong>Email:</strong> contact@claycrple.com</p>
        </div>
        <div class="vendor-actions">
          <button class="btn">Upload Image</button>
          <button class="btn">Update Info</button>
        </div>
      </section>

      <!-- 1) Vendor Classification (ALWAYS visible) -->
      <section class="card" style="margin-top: 16px;" id="typeGate">
        <h3>Vendor Type</h3>
        <p class="muted">Classify your business to tailor your dashboard and listing form.</p>

        <div class="type-grid">
          <label class="type-card">
            <input type="radio" name="vendorType" value="seller" />
            <div>
              <strong>Seller</strong>
              <p>Furniture • Painting • Decoration • দেশীয় মৃতশিল্প</p>
            </div>
          </label>

        <label class="type-card">
            <input type="radio" name="vendorType" value="service" />
            <div>
              <strong>Service Provider</strong>
              <p>Interior Designer • Electrician • Plumber • Painter</p>
            </div>
          </label>
        </div>

        <div class="row-actions">
          <button class="btn" id="saveTypeBtn" type="button">Save Type</button>
          <span id="typeStatus" class="status muted"></span>
        </div>
      </section>

      <!-- 2) Create Listing (GATED: show after type chosen) -->
      <section class="card gated hidden" id="createListingSection">
        <h3>Create Listing</h3>
        <p class="muted" id="formHint">Choose your vendor type above to reveal the right fields.</p>

        <!-- Shared fields -->
        <div class="form-grid">
          <label class="form-field">
            <span>Title *</span>
            <input id="listingTitle" type="text" placeholder="e.g., Oak Study Desk / Plumbing Fix Package" />
          </label>

          <label class="form-field">
            <span>Description *</span>
            <textarea id="listingDesc" rows="3" placeholder="Describe your product/service..."></textarea>
          </label>
        </div>

        <!-- Seller-specific -->
        <div id="sellerFields" class="form-grid hidden">
          <label class="form-field">
            <span>Category *</span>
            <select id="productCategory">
              <option value="">Select a category</option>
              <option value="furniture">Furniture</option>
              <option value="painting">Painting</option>
              <option value="decoration">Decoration</option>
              <option value="deshi_mritshilpo">দেশীয় মৃতশিল্প</option>
            </select>
          </label>

          <label class="form-field">
            <span>Price (BDT) *</span>
            <input id="productPrice" type="number" min="0" step="1" placeholder="e.g., 4500" />
          </label>

          <label class="form-field">
            <span>Stock *</span>
            <input id="productStock" type="number" min="0" step="1" placeholder="e.g., 10" />
          </label>

          <label class="form-field col-span-2">
            <span>Image URL (optional)</span>
            <input id="productImage" type="url" placeholder="https://..." />
          </label>
        </div>

        <!-- Service-specific -->
        <div id="serviceFields" class="form-grid hidden">
          <label class="form-field">
            <span>Service Type *</span>
            <select id="serviceCategory">
              <option value="">Select a service</option>
              <option value="interior_design">Interior Designer</option>
              <option value="electrician">Electrician</option>
              <option value="plumber">Plumber</option>
              <option value="painter">Painter</option>
            </select>
          </label>

          <label class="form-field">
            <span>Rate (BDT) *</span>
            <input id="serviceRate" type="number" min="0" step="1" placeholder="e.g., 1200" />
          </label>

          <label class="form-field">
            <span>Billing *</span>
            <select id="serviceBilling">
              <option value="fixed">Fixed</option>
              <option value="hourly">Hourly</option>
            </select>
          </label>

          <label class="form-field">
            <span>Service Area *</span>
            <input id="serviceArea" type="text" placeholder="e.g., Dhaka, BD" />
          </label>
        </div>

        <div class="row-actions">
          <button class="btn" id="clearFormBtn" type="button">Clear</button>
          <button class="btn primary" id="createListingBtn" type="button">Save Listing</button>
          <span id="createStatus" class="status muted"></span>
        </div>
      </section>

      <!-- 3) My Listings (GATED) -->
      <section class="card gated hidden" id="myListingsSection">
        <h3>My Listings</h3>
        <div class="row-actions" style="margin: 8px 0 12px;">
          <label class="form-field" style="min-width:240px;">
            <span>Filter by category</span>
            <select id="categoryFilter"></select>
          </label>
        </div>
        <div id="listingsContainer" class="products-grid"></div>
        <p class="muted" id="noListings" style="display:none;">No listings yet. Create one above.</p>
      </section>

      <!-- 4) Optional: other dashboard pieces (GATED) -->
      <section class="card gated hidden" id="statsSection">
        <h3>Stats</h3>
        <div class="stats-cards">
          <div class="stat-box">
            <div class="stat-icon sold"><i class="fas fa-shopping-cart"></i></div>
            <p>Products Sold</p>
            <h2>124</h2>
          </div>
          <div class="stat-box">
            <div class="stat-icon stock"><i class="fas fa-boxes"></i></div>
            <p>In Stock</p>
            <h2>78</h2>
          </div>
          <div class="stat-box">
            <div class="stat-icon revenue"><i class="fas fa-dollar-sign"></i></div>
            <p>Total Revenue</p>
            <h2>$5,420</h2>
          </div>
          <div class="stat-box">
            <div class="stat-icon reviews"><i class="fas fa-star"></i></div>
            <p>Reviews</p>
            <h2>320</h2>
          </div>
        </div>
      </section>

      <section class="card gated hidden" id="topProductsSection">
        <h3>Top-Performing Products</h3>
        <div class="products-grid">
          <div class="product-card">
            <img src="../images/p1.jpg" alt="Terracotta Vase" />
            <p>Terracotta Vase</p>
          </div>
          <div class="product-card processing">
            <img src="../images/p4.jpg" alt="Blue Bowl" />
            <p>Blue Bowl <span>Processing</span></p>
          </div>
          <div class="product-card">
            <img src="../images/p8.jpg" alt="Macrame Art" />
            <p>Macrame Art <span class="active">30 hours</span></p>
          </div>
        </div>
      </section>

      <section class="card gated hidden" id="inquiriesSection">
        <h3>Customer Inquiries</h3>
        <p><strong>Maisha:</strong> Interested in vase (1 min ago)</p>
        <p><strong>New Followers:</strong> 45</p>
      </section>
    </main>
  </div>

  <script>
    // =========================
    // CONFIG
    // =========================
    const API_BASE = "http://localhost:5000"; // <-- change if your server runs elsewhere
    const VENDOR_ID = 1;                      // <-- set this from your real session/login

    // ===== Sidebar "active" toggling (unchanged) =====
    const items = document.querySelectorAll('.sidebar ul li');
    items.forEach((item) => {
      item.addEventListener('click', () => {
        items.forEach((i) => i.classList.remove('active'));
        item.classList.add('active');
      });
    });

    // ===== Helpers for gated visibility =====
    const GATED_SECTION_IDS = [
      'createListingSection',
      'myListingsSection',
      'statsSection',
      'topProductsSection',
      'inquiriesSection',
    ];
    function setGateVisibility(type) {
      const show = type === 'seller' || type === 'service';
      GATED_SECTION_IDS.forEach((id) => {
        const el = document.getElementById(id);
        if (!el) return;
        if (show) {
          el.classList.remove('hidden');
          requestAnimationFrame(() => el.classList.add('ready'));
        } else {
          el.classList.add('hidden');
          el.classList.remove('ready');
        }
      });
    }

    // ===== Vendor Type controls =====
    const typeRadios = document.querySelectorAll('input[name="vendorType"]');
    const saveTypeBtn = document.getElementById('saveTypeBtn');
    const typeStatus = document.getElementById('typeStatus');
    const sellerFields = document.getElementById('sellerFields');
    const serviceFields = document.getElementById('serviceFields');
    const formHint = document.getElementById('formHint');

    // Gated sections & filter
    const createSection = document.getElementById('createListingSection');
    const myListingsSection = document.getElementById('myListingsSection');
    const categoryFilter = document.getElementById('categoryFilter');

    // Form selects
    const productCategorySel = document.getElementById('productCategory');
    const serviceCategorySel = document.getElementById('serviceCategory');

    // ===== API helpers =====
    async function apiGET(path) {
      const res = await fetch(`${API_BASE}${path}`);
      const json = await res.json();
      if (!res.ok || json.ok === false) throw new Error(json.error || `GET ${path} failed`);
      return json.data ?? json;
    }
    async function apiJSON(path, method, body) {
      const res = await fetch(`${API_BASE}${path}`, {
        method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body || {}),
      });
      const json = await res.json();
      if (!res.ok || json.ok === false) throw new Error(json.error || `${method} ${path} failed`);
      return json.data ?? json;
    }

    // ===== Lookups (categories) =====
    async function loadLookups() {
      // Load product categories
      const prodCats = await apiGET("/api/lookups/product-categories");
      productCategorySel.innerHTML = `<option value="">Select a category</option>` +
        prodCats.map(c => `<option value="${c.slug}">${c.name}</option>`).join("");

      // Load service categories
      const servCats = await apiGET("/api/lookups/service-categories");
      serviceCategorySel.innerHTML = `<option value="">Select a service</option>` +
        servCats.map(c => `<option value="${c.slug}">${c.name}</option>`).join("");
    }

    // ===== Vendor type (DB-backed) =====
    async function loadVendorTypeFromDB() {
      try {
        if (!VENDOR_ID) return "";
        const data = await apiGET(`/api/vendors/${VENDOR_ID}/type`);
        return data?.vendor_type || "";
      } catch {
        return "";
      }
    }
    function updateFormForType(type) {
      if (type === 'seller') {
        sellerFields.classList.remove('hidden');
        serviceFields.classList.add('hidden');
        formHint.textContent = 'Create a product listing to sell on Nibash.';
      } else if (type === 'service') {
        sellerFields.classList.add('hidden');
        serviceFields.classList.remove('hidden');
        formHint.textContent = 'Create a service package listing for customers.';
      } else {
        sellerFields.classList.add('hidden');
        serviceFields.classList.add('hidden');
        formHint.textContent = 'Choose your vendor type above to reveal the right fields.';
      }
    }

    // Save vendor type -> DB
    saveTypeBtn.addEventListener('click', async () => {
      const selected = document.querySelector('input[name="vendorType"]:checked');
      if (!selected) {
        typeStatus.textContent = 'Select a type first.';
        typeStatus.style.color = 'crimson';
        setGateVisibility('');
        return;
      }
      try {
        await apiJSON(`/api/vendors/${VENDOR_ID}/type`, "PATCH", { vendor_type: selected.value });
        localStorage.setItem('vendorType', selected.value);
        typeStatus.textContent = 'Saved!';
        typeStatus.style.color = 'green';
        setGateVisibility(selected.value);
        await buildCategoryFilter();
        await renderListingsFromAPI();
        const first = document.getElementById('listingTitle');
        if (first) first.focus();
      } catch (e) {
        typeStatus.textContent = e.message;
        typeStatus.style.color = 'crimson';
      }
    });

    // ===== Create Listing -> DB =====
    const createBtn = document.getElementById('createListingBtn');
    const clearBtn = document.getElementById('clearFormBtn');
    const createStatus = document.getElementById('createStatus');
    const listingsContainer = document.getElementById('listingsContainer');
    const noListings = document.getElementById('noListings');

    createBtn.addEventListener('click', async () => {
      try {
        createStatus.textContent = 'Saving...';
        createStatus.style.color = 'inherit';

        const listing = readListingForm();
        await saveListingToAPI(listing);    // persists to DB
        await buildCategoryFilter();         // ensure filter has latest categories in use
        await renderListingsFromAPI();       // renders from DB
        clearForm();

        createStatus.textContent = 'Saved!';
        createStatus.style.color = 'green';
        listingsContainer.scrollIntoView({ behavior: 'smooth' });
      } catch (e) {
        createStatus.textContent = e.message;
        createStatus.style.color = 'crimson';
      }
    });

    clearBtn.addEventListener('click', () => {
      clearForm();
      createStatus.textContent = '';
    });

    function readListingForm() {
      const type = localStorage.getItem('vendorType');
      const title = document.getElementById('listingTitle').value.trim();
      const description = document.getElementById('listingDesc').value.trim();

      if (!type) throw new Error('Please choose your vendor type above.');
      if (!title || !description) throw new Error('Title and Description are required.');

      if (type === 'seller') {
        const category = productCategorySel.value;
        const price = document.getElementById('productPrice').value;
        const stock = document.getElementById('productStock').value;
        const image_url = document.getElementById('productImage').value.trim();

        if (!category || price === '' || stock === '') {
          throw new Error('Please complete all product fields.');
        }

        return {
          type,
          title,
          description,
          category,                       // slug from lookups
          price: parseInt(price, 10),
          stock: parseInt(stock, 10),
          image_url: image_url || null,
        };
      } else {
        const service_type = serviceCategorySel.value; // slug from lookups
        const rate = document.getElementById('serviceRate').value;
        const billing = document.getElementById('serviceBilling').value;
        const area = document.getElementById('serviceArea').value.trim();

        if (!service_type || rate === '' || !billing || !area) {
          throw new Error('Please complete all service fields.');
        }

        return {
          type,
          title,
          description,
          service_type,
          rate: parseInt(rate, 10),
          billing,
          area,
        };
      }
    }

    async function saveListingToAPI(listing) {
      if (!VENDOR_ID) throw new Error("Missing vendor id (not logged in?)");

      if (listing.type === "seller") {
        const payload = {
          vendor_id: VENDOR_ID,
          title: listing.title,
          description: listing.description,
          category_slug: listing.category,   // e.g. furniture
          price_bdt: listing.price,
          stock: listing.stock,
          image_url: listing.image_url || null,
        };
        await apiJSON("/api/products", "POST", payload);
      } else {
        const payload = {
          vendor_id: VENDOR_ID,
          title: listing.title,
          description: listing.description,
          service_category_slug: listing.service_type, // e.g. plumber
          rate_bdt: listing.rate,
          billing: listing.billing,      // only stored if your DB has columns for it
          service_area: listing.area,    // only stored if your DB has columns for it
          image_url: null,               // or include one if you add UI
        };
        await apiJSON("/api/services", "POST", payload);
      }
    }

    // ===== Category filter (from lookups) =====
    async function buildCategoryFilter() {
      const type = localStorage.getItem('vendorType') || '';
      if (!type) {
        categoryFilter.innerHTML = '';
        return;
      }

      if (type === 'seller') {
        const cats = await apiGET("/api/lookups/product-categories");
        categoryFilter.innerHTML =
          `<option value="">All product categories</option>` +
          cats.map(c => `<option value="${c.slug}">${c.name}</option>`).join("");
      } else {
        const cats = await apiGET("/api/lookups/service-categories");
        categoryFilter.innerHTML =
          `<option value="">All service types</option>` +
          cats.map(c => `<option value="${c.slug}">${c.name}</option>`).join("");
      }
    }

    // ===== Render from DB (Products/Services) =====
    async function renderListingsFromAPI() {
      const type = localStorage.getItem('vendorType');
      listingsContainer.innerHTML = '';

      if (!type) {
        noListings.style.display = 'block';
        noListings.textContent = 'Choose a vendor type to view or create listings.';
        return;
      }

      const selectedFilter = (categoryFilter && categoryFilter.value) || '';
      let url = type === 'seller' ? `/api/products?vendor_id=${VENDOR_ID}` 
                                  : `/api/services?vendor_id=${VENDOR_ID}`;
      if (selectedFilter) url += `&category_slug=${encodeURIComponent(selectedFilter)}`;

      try {
        const rows = await apiGET(url);
        if (!rows.length) {
          noListings.style.display = 'block';
          noListings.textContent = 'No listings yet. Create one above.';
          return;
        }
        noListings.style.display = 'none';

        rows.forEach((item) => {
          const card = document.createElement('div');
          card.className = 'product-card';

          const imgUrl = item.image_url || item.primary_image_url;
          if (imgUrl) {
            const img = document.createElement('img');
            img.src = imgUrl;
            img.alt = item.title;
            card.appendChild(img);
          }

          const p = document.createElement('p');
          const sub = item.category_slug || item.category_name || (type === 'seller' ? 'Product' : 'Service');
          p.innerHTML = `<strong>${item.title}</strong><br><span class="muted">${sub}</span>`;
          card.appendChild(p);
          listingsContainer.appendChild(card);
        });
      } catch (err) {
        noListings.style.display = 'block';
        noListings.textContent = `Failed to load listings: ${err.message}`;
      }
    }

    function clearForm() {
      document.getElementById('listingTitle').value = '';
      document.getElementById('listingDesc').value = '';
      const ids = [
        'productCategory', 'productPrice', 'productStock', 'productImage',
        'serviceCategory', 'serviceRate', 'serviceBilling', 'serviceArea',
      ];
      ids.forEach((id) => {
        const el = document.getElementById(id);
        if (!el) return;
        if (el.tagName === 'SELECT') {
          if (id === 'serviceBilling') el.value = 'fixed';
          else el.value = '';
        } else {
          el.value = '';
        }
      });
    }

    // ===== Init =====
    (async function init() {
      try {
        await loadLookups(); // populate form selects from API

        // Load vendor type from DB; fall back to localStorage if DB empty
        let vt = await loadVendorTypeFromDB();
        if (!vt) vt = localStorage.getItem('vendorType') || '';

        if (vt) {
          const radio = document.querySelector(`input[name="vendorType"][value="${vt}"]`);
          if (radio) radio.checked = true;
          localStorage.setItem('vendorType', vt);
        }
        updateFormForType(vt);
        setGateVisibility(vt);

        await buildCategoryFilter();
        await renderListingsFromAPI();
      } catch (e) {
        console.error(e);
      }
    })();

    // React to filter changes
    if (categoryFilter) {
      categoryFilter.addEventListener("change", renderListingsFromAPI);
    }

    // Update UI when type radio changes (before saving to DB)
    const typeRadios2 = document.querySelectorAll('input[name="vendorType"]');
    typeRadios2.forEach((r) => {
      r.addEventListener('change', async () => {
        updateFormForType(r.value);
        setGateVisibility(r.value);
        localStorage.setItem('vendorType', r.value); // temp until user clicks Save
        await buildCategoryFilter();
        await renderListingsFromAPI();
      });
    });
  </script>
</body>
</html>
