<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vendor Dashboard ‚Äî Nibash</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <link href="../css/dashb.css" rel="stylesheet">
  <style>
    .muted { color:#7a6f67 }
    .loading { opacity:.7; font-size:14px; color:#7a6f67; padding:12px }

    /* Wider, roomier seller rows */
    .seller-row {
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap:14px;
    }
    .seller-card {
      background:#fff; border-radius:16px; padding:14px;
      box-shadow:0 1px 3px rgba(0,0,0,.06);
      display:flex; flex-direction:column; align-items:flex-start; gap:8px; min-height:120px;
    }
    .seller-card .topline { display:flex; align-items:center; gap:12px; width:100% }
    .seller-card .avatar img { width:44px; height:44px; border-radius:999px; object-fit:cover }
    .seller-card .meta { line-height:1.15; flex:1 }
    .seller-card .name { font-weight:700; font-size:15px }
    .seller-card .sub { font-size:12px; color:#9a8f85 }
    .seller-card .desc { margin-top:2px; color:#6e645c; font-size:12px; line-height:1.35;
                         display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden }
    .seller-card .stats { display:flex; gap:8px; align-items:center; font-size:12px; color:#7a6f67 }
    .seller-card .btn { padding:8px 12px; font-size:12px; width:100%; margin-top:6px }
    .coords { font-variant-numeric:tabular-nums }

    /* Products */
    .creationsGrid { display:grid; grid-template-columns: repeat(auto-fill,minmax(220px,1fr)); gap:14px }
    .product { background:#fff; border-radius:16px; padding:12px; box-shadow:0 1px 3px rgba(0,0,0,.06) }
    .product img { width:100%; height:180px; object-fit:cover; border-radius:12px }
  </style>
</head>
<body class="theme-pottery">

  <header>
    <div class="logo"><img src="../images/mainLogo.png" alt="Nibash Logo" class="logo-img">Nibash</div>
    <nav>
      <a href="../users/customer.html">Home</a>
      <a href="../index.html" class="logout-btn">Log out</a>
    </nav>
  </header>

  <div class="dashboard">
    <aside class="sidebar" aria-label="Account menu">
      <a href="../users/customerDashboard.html"><h3>My Account</h3></a>
      <a href="#" class="active">Profile</a>
      <a href="#">Wishlist</a>
      <a href="#">Orders</a>
      <a href="#">Saved Collections</a>
      <a href="#">Settings</a>
    </aside>

    <main class="content">
      <!-- (Notice removed as requested) -->

      <section class="hero" role="banner" aria-label="hero">
        <div class="hero-slider" aria-hidden="true">
          <div class="slide active" style="background-image:url('../images/pott.webp')"></div>
          <div class="slide" style="background-image:url('../images/p7.jpg')"></div>
          <div class="slide" style="background-image:url('../images/pottery2.jpg')"></div>
        </div>
        <button class="hero-arrow prev" aria-label="Previous slide">‚Äπ</button>
        <button class="hero-arrow next" aria-label="Next slide">‚Ä∫</button>
        <div class="hero-text-overlay" aria-live="polite">
          <h1>Guardians of Clay: <br> Bangladesh Pottery</h1>
          <p>Experience the soul of Bangladesh in every handcrafted piece. Step into a world where clay isn't just a material, but a canvas of history, culture, and passion.</p>
          <div class="cta">
            <button class="btn white" id="contactSupportBtn">Contact Support</button>
            <button class="btn dark" id="browseBtn">Browse New Arrivals</button>
          </div>
        </div>
      </section>

      <!-- Sellers -->
      <section class="section" id="recommended-sellers">
        <h3>Nearby Sellers</h3>
        <div id="sellerListNearby" class="seller-row">
          <div class="loading">Loading nearby sellers‚Ä¶</div>
        </div>

        <h3 style="margin-top:18px">Top Sellers in this Category</h3>
        <div id="sellerListTop" class="seller-row">
          <div class="loading">Loading top sellers‚Ä¶</div>
        </div>
      </section>

      <!-- Products -->
      <section class="section" id="recommended-products">
        <h3>Recommended For You</h3>
        <div id="productGrid" class="creationsGrid">
          <div class="loading">Loading products‚Ä¶</div>
        </div>
      </section>
    </main>
  </div>

  <!-- Chat Modal -->
  <div class="chat-modal" id="chatModal" role="dialog" aria-modal="true" aria-labelledby="chatTitle">
    <div class="chat-box" role="document">
      <button class="chat-close" id="chatCloseBtn" aria-label="Close chat">‚úï</button>
      <h4 id="chatTitle">Message Seller</h4>
      <div class="meta" id="chatMeta">To: <strong id="chatSeller">‚Äî</strong> ¬∑ Product: <span id="chatProduct">‚Äî</span></div>
      <textarea id="chatMessage" placeholder="Write a short message..." style="width:100%;height:110px;padding:10px;border-radius:8px;border:1px solid #ddd;resize:vertical"></textarea>
      <div style="display:flex;gap:8px;margin-top:10px;justify-content:flex-end">
        <button class="btn white" id="chatCancel">Cancel</button>
        <button class="btn dark" id="chatSend">Send Message</button>
      </div>
      <div id="chatStatus" style="margin-top:10px;font-size:13px;color:green;display:none">Message sent ‚úî</div>
    </div>
  </div>

<script>
  const API_BASE = 'http://localhost:5555';

  // ---------- general helpers ----------
  function getQueryInt(key, fallback) {
    const v = new URLSearchParams(location.search).get(key);
    const n = Number(v);
    return Number.isFinite(n) ? n : fallback;
  }

  async function getCoords() {
    const fallback = { lat: 23.8103, lng: 90.4125 }; // Dhaka fallback
    try {
      const pos = await new Promise((resolve, reject) =>
        navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 6000 })
      );
      return { lat: pos.coords.latitude, lng: pos.coords.longitude };
    } catch {
      return fallback;
    }
  }

  // ---------- chat wiring ----------
  const chatModal = document.getElementById('chatModal');
  const chatSeller = document.getElementById('chatSeller');
  const chatProduct = document.getElementById('chatProduct');
  const chatMessage = document.getElementById('chatMessage');
  const chatStatus = document.getElementById('chatStatus');
  const chatCloseBtn = document.getElementById('chatCloseBtn');
  const chatCancel = document.getElementById('chatCancel');
  const chatSend = document.getElementById('chatSend');

  function openChat({ seller = '‚Äî', product = '‚Äî' } = {}) {
    chatSeller.textContent = seller || '‚Äî';
    chatProduct.textContent = product || '‚Äî';
    chatMessage.value = `Hi ${seller || 'there'}, I'm interested in "${product || 'your product'}". Can I know more?`;
    chatStatus.style.display = 'none';
    chatModal.classList.add('active');
    chatMessage.focus();
  }
  function closeChat() { chatModal.classList.remove('active'); }
  chatCloseBtn.addEventListener('click', closeChat);
  chatCancel.addEventListener('click', closeChat);
  chatModal.addEventListener('click', (e) => { if (e.target === chatModal) closeChat(); });
  chatSend.addEventListener('click', () => {
    chatStatus.textContent = 'Message sent ‚úî';
    chatStatus.style.display = 'block';
    setTimeout(closeChat, 900);
  });

  // ---------- renderers ----------
  function safeText(s) {
    return String(s ?? '').replace(/[&<>"']/g, m => (
      { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]
    ));
  }
  function pick(vals, ...keys) {
    for (const k of keys) {
      const val = vals[k];
      if (val !== undefined && val !== null && String(val).trim() !== '') return val;
    }
    return undefined;
  }
  function getDesc(v) {
    // Prefer exact DB field: Vendor_description
    return pick(
      v,
      'Vendor_description', 'Vendor_Description', 'vendor_description',
      'vendorDescription', 'description', 'VendorDesc', 'VendorDesciption' // a couple of common typos/variants
    );
  }
  function extractCoords(v) {
    const lat = Number(pick(v, 'vendor_latitude','vendor_lat','latitude','lat'));
    const lng = Number(pick(v, 'vendor_longitude','vendor_lng','longitude','lng'));
    return (Number.isFinite(lat) && Number.isFinite(lng)) ? { lat, lng } : null;
  }
  function fmtCoord(n) { return (Number.isFinite(n)) ? n.toFixed(4) : '‚Äî'; }

  function sellerCardHTML(v) {
    const rating = Number(v.avg_rating_cat ?? v.avg_rating ?? 0) || 0;
    const count  = Number(v.rating_count_cat ?? v.rating_count ?? 0) || 0;
    const dist   = Number(v.distance_km ?? NaN);
    const distKm = Number.isFinite(dist) ? `${dist.toFixed(1)} km` : '';
    const coords = extractCoords(v);
    const descRaw = getDesc(v);
    const desc = descRaw ? safeText(descRaw) : '';

    const coordLine = coords
      ? `<span class="coords">üìç ${fmtCoord(coords.lat)}, ${fmtCoord(coords.lng)}</span>`
      : '';

    return `
      <div class="seller-card">
        <div class="topline">
          <div class="avatar"><img src="${v.logo_url || '../images/artist.jpg'}" alt="${(v.Vendor_Name||'Seller')}"></div>
          <div class="meta">
            <div class="name">${safeText(v.Vendor_Name || 'Seller')}</div>
            <div class="sub">${safeText(v.location || '')}${distKm ? ' ¬∑ ' + distKm : ''}</div>
          </div>
        </div>
        ${desc ? `<div class="desc">${desc}</div>` : ''}
        <div class="stats">
          <span>‚≠ê ${rating || '‚Äî'} (${count})</span>
          ${coordLine ? `<span>¬∑</span>${coordLine}` : ''}
        </div>
        <button class="btn white contact-seller" data-seller="${safeText(v.Vendor_Name || 'Seller')}" data-product="General Inquiry">Message</button>
      </div>
    `;
  }

  function renderSellerRow(containerId, vendors) {
    const el = document.getElementById(containerId);
    if (!Array.isArray(vendors) || vendors.length === 0) {
      el.innerHTML = `<div class="card" style="padding:12px">No sellers found.</div>`;
      return;
    }
    el.innerHTML = vendors.map(sellerCardHTML).join('');
    el.querySelectorAll('.contact-seller').forEach(btn => {
      btn.addEventListener('click', () => {
        const seller = btn.dataset.seller || 'Seller';
        openChat({ seller, product: 'General Inquiry' });
      });
    });
  }

  function renderProducts(products) {
    const grid = document.getElementById('productGrid');
    if (!Array.isArray(products) || products.length === 0) {
      grid.innerHTML = `<div class="card" style="padding:12px">No products in this category yet.</div>`;
      return;
    }
    grid.innerHTML = products.map(p => `
      <div class="product">
        <img src="${p.image_url || '../images/pottery4.webp'}" alt="${safeText(p.title||'Product')}" onerror="this.src='../images/pottery4.webp'">
        <div class="txt">${safeText(p.title || 'Untitled product')}</div>
        <div class="muted" style="font-size:13px">${safeText(p.Vendor_Name || '')}</div>
        <div style="font-weight:700;color:var(--accent)">‡ß≥${Number(p.price_bdt ?? 0)}</div>
        <div style="display:flex; gap:8px; margin-top:6px">
          <button class="btn white contact-seller" data-product="${safeText(p.title || 'Product')}" data-seller="${safeText(p.Vendor_Name || 'Seller')}">Contact seller</button>
          <button class="btn dark add-wishlist" data-productid="${p.product_id}">Add to wishlist</button>
        </div>
      </div>
    `).join('');

    grid.querySelectorAll('.contact-seller').forEach(btn => {
      btn.addEventListener('click', () => {
        const seller = btn.dataset.seller || 'Seller';
        const product = btn.dataset.product || 'Product';
        openChat({ seller, product });
      });
    });
  }

  // ---------- API helpers ----------
  async function fetchJson(url) {
    const res = await fetch(url);
    try { return await res.json(); } catch { return null; }
  }
  const toList = j => (j && (j.items ?? j.data)) || [];
  const normalizeVendors = list => list.map(v => ({
    ...v,
    distance_km: Number(v.distance_km ?? NaN),
    avg_rating_cat: Number(v.avg_rating_cat ?? v.avg_rating ?? NaN),
  }));
  const sortNearby = vs => vs.sort((a,b) => {
    const ad = Number.isFinite(a.distance_km) ? a.distance_km : Infinity;
    const bd = Number.isFinite(b.distance_km) ? b.distance_km : Infinity;
    return ad - bd;
  });
  const sortTop = vs => vs.sort((a,b) => {
    const ar = Number.isFinite(b.avg_rating_cat) ? b.avg_rating_cat : -Infinity;
    const br = Number.isFinite(a.avg_rating_cat) ? a.avg_rating_cat : -Infinity;
    if (ar !== br) return ar - br; // desc
    const ad = Number.isFinite(a.distance_km) ? a.distance_km : Infinity;
    const bd = Number.isFinite(b.distance_km) ? b.distance_km : Infinity;
    return ad - bd;
  });

  async function cascade(urlBuilder, radii) {
    for (const r of radii) {
      const url = urlBuilder(r);
      const json = await fetchJson(url);
      const list = toList(json);
      if (list.length) return { list, radiusUsed: r };
    }
    return { list: [], radiusUsed: radii[radii.length - 1] };
  }

  // ---------- main loader (no notice usage) ----------
  async function loadAll({ coords, catId }) {
    const nearby = await cascade(
      (r)=>`${API_BASE}/api/recommendations/vendors?latitude=${coords.lat}&longitude=${coords.lng}&product_category_id=${catId}&radiusKm=${r}&limit=24`,
      [25, 50, 100, 300]
    );

    const top = await cascade(
      (r)=>`${API_BASE}/api/recommendations/vendors?latitude=${coords.lat}&longitude=${coords.lng}&product_category_id=${catId}&radiusKm=${r}&limit=48`,
      [300, 600, 1000]
    );

    const prods = await cascade(
      (r)=>`${API_BASE}/api/recommendations/products?latitude=${coords.lat}&longitude=${coords.lng}&product_category_id=${catId}&radiusKm=${r}&limit=12`,
      [50, 100, 300, 600, 1000]
    );

    let nearbyList = nearby.list;
    let topList    = top.list;
    let prodList   = prods.list;

    // Fallback to Dhaka only for missing BOTH seller lists
    if (nearbyList.length === 0 && topList.length === 0) {
      const dhaka = { lat: 23.8103, lng: 90.4125 };
      const dhNearby = await cascade(
        (r)=>`${API_BASE}/api/recommendations/vendors?latitude=${dhaka.lat}&longitude=${dhaka.lng}&product_category_id=${catId}&radiusKm=${r}&limit=24`,
        [25, 50, 100, 300]
      );
      const dhTop = await cascade(
        (r)=>`${API_BASE}/api/recommendations/vendors?latitude=${dhaka.lat}&longitude=${dhaka.lng}&product_category_id=${catId}&radiusKm=${r}&limit=48`,
        [300, 600, 1000]
      );
      if (prodList.length === 0) {
        const dhProds = await cascade(
          (r)=>`${API_BASE}/api/recommendations/products?latitude=${dhaka.lat}&longitude=${dhaka.lng}&product_category_id=${catId}&radiusKm=${r}&limit=12`,
          [50, 100, 300, 600, 1000]
        );
        prodList = dhProds.list;
      }
      nearbyList = dhNearby.list;
      topList = dhTop.list;
    }

    const nearbyNorm = sortNearby(normalizeVendors(nearbyList)).slice(0, 12);
    const topNorm    = sortTop(normalizeVendors(topList)).slice(0, 12);

    renderSellerRow('sellerListNearby', nearbyNorm);
    renderSellerRow('sellerListTop', topNorm);
    renderProducts(prodList);
  }

  // ---------- boot ----------
  (async function boot() {
    const rawCat = getQueryInt('cat', 4);
    const catId = (Number.isFinite(rawCat) && rawCat > 0) ? rawCat : 4;
    const coords = await getCoords();
    await loadAll({ coords, catId });
  })();
</script>

</body>
</html>
