<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Technicians - Nibash</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #faf9f7;
      --card: #f5efe6;
      --accent: #8a5a3a;
      --muted: #bfb6ad;
      --soft: #f1e8dd;
      --shadow: rgba(20, 20, 20, 0.06);
    }

    * {
      box-sizing: border-box;
      font-family: 'Poppins', system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: #333;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      min-height: 100vh;
    }

    /* Header */
    header {
      background: white;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      font-size: 22px;
    }

    .logo-img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }

    header nav a {
      margin-left: 1rem;
      text-decoration: none;
      color: #333;
    }

    .logout-btn {
      background: #b71c1c;
      color: white;
      padding: 0.4rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      border: none;
      font-weight: 600;
    }

    /* layout */
    .dashboard {
      display: flex;
      min-height: calc(100vh - 60px);
    }

    /* Sidebar */
    .sidebar {
      width: 220px;
      background: white;
      padding: 1.5rem;
      border-right: 1px solid #eee;
      position: relative;
    }

    .sidebar h3 {
      margin-bottom: 1rem;
      font-weight: 600;
    }

    .sidebar a {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.6rem 1rem;
      margin: 0.3rem 0;
      text-decoration: none;
      color: #555;
      border-radius: 6px;
      position: relative;
    }

    .sidebar a:hover {
      background: #f5efe6;
      font-weight: 600;
    }

    .sidebar a::after {
      content: "‚ñ∂";
      font-size: 1rem;
      opacity: 0.5;
      pointer-events: none;
    }

    /* main content */
    .content {
      flex: 1;
      padding: 2rem;
    }

    /* HERO / SLIDER */
    .hero {
      position: relative;
      overflow: hidden;
      border-radius: 12px;
      min-height: 400px;
      box-shadow: 0 8px 24px var(--shadow);
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      padding: 28px;
      gap: 24px;
      background: linear-gradient(135deg, #2c3e50, #4a2c18);
    }

    .hero-text-overlay {
      position: relative;
      z-index: 3;
      width: min(680px, 63%);
      background: rgba(255, 255, 255, 0.06);
      color: #fff;
      padding: 28px;
      border-radius: 12px;
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
    }

    .hero-text-overlay h1 {
      margin: 0 0 12px 0;
      font-size: 32px;
      line-height: 1.05;
      font-weight: 700;
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.55);
    }

    .hero-text-overlay p {
      margin: 0;
      opacity: 0.95;
      line-height: 1.6;
      font-size: 15px;
      color: #fff;
    }

    /* Controls */
    .controls {
      background: var(--card);
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 6px 18px var(--shadow);
      margin-bottom: 1.5rem;
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
    }

    .filters {
      display: flex;
      gap: 16px;
      align-items: center;
      flex-wrap: wrap;
    }

    .filters label {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 14px;
      font-weight: 600;
    }

    .filters select,
    .filters input {
      padding: 8px 12px;
      border: 1px solid var(--muted);
      border-radius: 6px;
      font-size: 14px;
    }

    .search-btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .search-btn:hover {
      background: #d38b5f;
      transform: translateY(-2px);
    }

    /* Service Cards */
    .services {
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }

    .sub-section h2 {
      margin: 0 0 1rem 0;
      font-size: 1.5rem;
      color: var(--accent);
      font-weight: 600;
    }

    .service-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 1rem;
    }

    .service-card {
      background: white;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 6px 18px var(--shadow);
      transition: transform 0.2s ease;
    }

    .service-card:hover {
      transform: translateY(-4px);
    }

    .card-top {
      display: flex;
      gap: 12px;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .card-top img {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      object-fit: cover;
      border: 3px solid white;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
      background: #f0f0f0;
    }

    .card-info h3 {
      margin: 0 0 4px 0;
      font-size: 1.1rem;
      font-weight: 600;
    }

    .vendor-id {
      display: inline-block;
      background: var(--soft);
      color: var(--accent);
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .meta {
      margin: 0 0 6px 0;
      font-size: 0.9rem;
      color: #666;
    }

    .rating {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.9rem;
      color: #ffa500;
    }

    .rating-num {
      color: #666;
      font-weight: 600;
    }

    .services-offered {
      margin: 8px 0;
      font-size: 0.85rem;
      color: #666;
      line-height: 1.4;
    }

    .card-actions {
      display: flex;
      gap: 8px;
    }

    .btn {
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      transition: all 0.2s ease;
      flex: 1;
    }

    .btn.small {
      padding: 6px 10px;
      font-size: 0.8rem;
    }

    .btn.primary {
      background: var(--accent);
      color: white;
    }

    .btn.ghost {
      background: transparent;
      border: 1px solid var(--muted);
      color: #666;
    }

    .btn:hover {
      transform: translateY(-2px);
    }

    .empty {
      text-align: center;
      color: #666;
      font-style: italic;
      padding: 2rem;
    }

    .loading {
      text-align: center;
      color: #666;
      padding: 2rem;
      font-style: italic;
    }

    .error {
      text-align: center;
      color: #dc3545;
      padding: 2rem;
      font-weight: 600;
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .sidebar {
        display: none;
      }

      .content {
        padding: 1rem;
      }

      .hero {
        min-height: 300px;
        padding: 1.5rem;
      }

      .controls {
        flex-direction: column;
        align-items: stretch;
      }
    }

    @media (max-width: 600px) {
      .service-list {
        grid-template-columns: 1fr;
      }

      .hero-text-overlay h1 {
        font-size: 24px;
      }

      .card-actions {
        flex-direction: column;
      }
    }
  </style>
</head>

<body>

  <header>
    <div class="logo"><img src="../images/mainLogo.png" alt="Nibash Logo" class="logo-img">Nibash</div>
    <nav>
      <a href="../users/customerDashboard.html">Dashboard</a>
      <a href="../users/customer.html">Home</a>
      <button class="logout-btn" id="logoutBtn">Log out</button>
    </nav>
  </header>

  <div class="dashboard">
    <!-- sidebar -->
    <aside class="sidebar" aria-label="Account menu">
      <a href="../users/customerDashboard.html">
        <h3>My Account</h3>
      </a>
      <a href="#" class="active">Find Technicians</a>
      <a href="../users/customerDashboard.html">Profile</a>
      <a href="../users/customerDashboard.html">Wishlist</a>
      <a href="../users/customerDashboard.html">Orders</a>
    </aside>

    <!-- main -->
    <main class="content">

      <!-- HERO -->
      <section class="hero" role="banner" aria-label="hero">
        <div class="hero-text-overlay" aria-live="polite">
          <h1>Find Trusted Home Service Professionals</h1>
          <p>
            Electricians, Plumbers & Painters ‚Äì highest rated, near you, and easy to contact.
            Connect with skilled professionals for all your home service needs.
          </p>
        </div>
      </section>

      <!-- Controls -->
      <section class="controls">
        <div class="filters">
         <label>
  Service Type:
  <select id="categoryFilter">
    <option value="">All Services</option>
    <option value="Electrician">Electrician</option>
    <option value="Plumber">Plumber</option>
    <option value="Painter">Painter</option>
    <option value="Interior Designer">Interior Designer</option>
  </select>
  </label>

          <label>
            Search Radius (km):
            <input type="number" id="radiusInput" min="1" max="50" value="5" />
          </label>

          <label>
            Sort By:
            <select id="sortBy">
              <option value="distance">Distance</option>
              <option value="rating">Rating</option>
            </select>
          </label>

          <button id="searchBtn" class="search-btn">üîç Search</button>
        </div>
      </section>

      <!-- Services Sections -->
      <section id="serviceArea" class="services">
        <div class="sub-section">
          <h2>Available Technicians</h2>
          <div id="techniciansList" class="service-list"></div>
        </div>
      </section>

    </main>
  </div>

  <script>
    const API_BASE = "http://localhost:5555";
    const CUSTOMER_TOKEN = localStorage.getItem("customerToken");
    const CUSTOMER_ID = Number(localStorage.getItem("customerId"));

    if (!CUSTOMER_ID || !CUSTOMER_TOKEN) {
      alert("‚ö† Not authenticated. Redirecting to login...");
      window.location.href = "../index.html";
    }

    let currentLat = 23.8103;
    let currentLng = 90.4125;

    // Load customer location
    async function loadCustomerLocation() {
      try {
        const res = await fetch(`${API_BASE}/api/customer/me`, {
          headers: { "Authorization": `Bearer ${CUSTOMER_TOKEN}` }
        });
        const json = await res.json();
        const me = json.data || json;
        
        if (me.latitude && me.longitude) {
          currentLat = parseFloat(me.latitude);
          currentLng = parseFloat(me.longitude);
        }
      } catch (e) {
        console.error("Failed to load location:", e);
      }
    }

    // Search technicians
    async function searchTechnicians() {
      try {
        const container = document.getElementById("techniciansList");
        container.innerHTML = '<p class="loading">üîç Searching technicians...</p>';

        const category = document.getElementById("categoryFilter").value;
        const radius = document.getElementById("radiusInput").value || 5;

        let query = `/api/recommendations/nearby-technicians?latitude=${currentLat}&longitude=${currentLng}&radiusKm=${radius}&limit=50`;
        if (category) query += `&category=${encodeURIComponent(category)}`;

        console.log("üîç Request:", `${API_BASE}${query}`);
        
        const res = await fetch(`${API_BASE}${query}`, {
          headers: { "Authorization": `Bearer ${CUSTOMER_TOKEN}` }
        });
        
        const json = await res.json();
        console.log("üì¶ Response:", json);
        
        if (!res.ok) throw new Error(json.error || "Failed to fetch technicians");

        const technicians = json.data || json.items || [];

        // Sort
        const sortBy = document.getElementById("sortBy").value;
        if (sortBy === "rating") {
          technicians.sort((a, b) => (b.rating || 0) - (a.rating || 0));
        } else {
          technicians.sort((a, b) => parseFloat(a.distance) - parseFloat(b.distance));
        }

        renderTechnicians(technicians);
      } catch (e) {
        console.error("Search error:", e);
        document.getElementById("techniciansList").innerHTML = 
          `<p class="error">‚ùå Error: ${e.message}</p>`;
      }
    }

    function renderTechnicians(technicians) {
      const container = document.getElementById("techniciansList");

      if (!technicians || technicians.length === 0) {
        container.innerHTML = '<p class="empty">üòï No technicians found in your area. Try increasing the search radius.</p>';
        return;
      }

      container.innerHTML = technicians.map(tech => {
        const logo = tech.logo_url || "../images/logo2.png";
        const rating = tech.rating || 0;
        const stars = "‚òÖ".repeat(Math.round(rating)) + "‚òÜ".repeat(5 - Math.round(rating));
        
        const servicesText = tech.services && tech.services.length > 0
          ? tech.services.map(s => s.category || s.title).join(", ")
          : tech.job_type || "Services available";

        return `
          <div class="service-card">
            <div class="card-top">
              <img src="${logo}" alt="${escapeHtml(tech.name)}" onerror="this.src='../images/logo2.png'" />
              <div class="card-info">
                <span class="vendor-id">ID: ${tech.vendor_id}</span>
                <h3>${escapeHtml(tech.name)}</h3>
                <p class="meta">üìç ${escapeHtml(tech.location)} (${tech.distance} km)</p>
                <p class="rating">${stars} <span class="rating-num">${Number(rating).toFixed(1)}</span></p>
              </div>
            </div>
            <p class="services-offered">üìã ${servicesText}</p>
            <p class="meta">‚òéÔ∏è ${tech.phone || "Contact via app"}</p>
            <div class="card-actions">
              <button class="btn primary small" onclick="contactTechnician('${escapeJs(tech.name)}', '${escapeJs(tech.phone || '')}')">Message</button>
              <button class="btn ghost small" onclick="callTechnician('${escapeJs(tech.phone || '')}')">Call</button>
            </div>
          </div>
        `;
      }).join("");
    }

    function contactTechnician(name, phone) {
      const msg = `Hi ${name}, I'm interested in your services. Please get back to me!`;
      alert(`üì± Contact: ${name}\n\n${msg}\n\n(Messaging feature coming soon)`);
    }

    function callTechnician(phone) {
      if (!phone || phone === "Contact via app") {
        alert("Phone number not available");
        return;
      }
      navigator.clipboard.writeText(phone);
      alert(`‚úÖ Phone copied: ${phone}`);
    }

    function escapeHtml(s) {
      if (!s) return "";
      return s.replace(/[&<>"']/g, c => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      })[c]);
    }

    function escapeJs(s) {
      return (s || "").replace(/'/g, "\\'").replace(/"/g, '\\"');
    }

    // Event listeners
    document.getElementById("searchBtn").addEventListener("click", searchTechnicians);
    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("customerToken");
      localStorage.removeItem("customerId");
      window.location.href = "../index.html";
    });

    // Init
    async function init() {
      await loadCustomerLocation();
      await searchTechnicians();
    }

    init();
  </script>
</body>

</html>